@model Blood_Donations_Project.ViewModels.Profile
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "My Profile";

    var role = Context.Session.GetString("UserRole") ?? "";
    var bloodTypesRaw = ViewBag.BloodTypes as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();

    bool isDonor = role.Equals("Donor", StringComparison.OrdinalIgnoreCase);
    bool isAdmin = role.Equals("Admin", StringComparison.OrdinalIgnoreCase);
    bool isHospitalOrBloodBank =
        role.Equals("Hospital", StringComparison.OrdinalIgnoreCase) ||
        role.Equals("BloodBank", StringComparison.OrdinalIgnoreCase);

    bool canEdit = isDonor || isAdmin;

    var genderItems = new List<SelectListItem>
    {
        new SelectListItem { Value = "", Text = "-- Select --" },
        new SelectListItem { Value = "Male", Text = "Male" },
        new SelectListItem { Value = "Female", Text = "Female" }
    };

    var bloodTypeSelectList = new SelectList(bloodTypesRaw, "BloodTypeId", "TypeName", Model.BloodTypeId);

    var textAttrs = canEdit
        ? new Dictionary<string, object> { ["class"] = "form-control" }
        : new Dictionary<string, object> { ["class"] = "form-control", ["readonly"] = "readonly" };

    var textAreaAttrs = canEdit
        ? new Dictionary<string, object> { ["class"] = "form-control" }
        : new Dictionary<string, object> { ["class"] = "form-control", ["readonly"] = "readonly" };

    var selectAttrs = canEdit
        ? new Dictionary<string, object> { ["class"] = "form-select" }
        : new Dictionary<string, object> { ["class"] = "form-select", ["disabled"] = "disabled" };

    var halfLg = "col-12 col-lg-6";
    var fullLg = "col-12 col-lg-12";

    var genderCol = isDonor ? halfLg : fullLg;

    var healthCol = isDonor ? halfLg : fullLg;

}

<style>
    @@media (min-width: 576px) {
        .profile-actions .btn {
            width: auto !important;
        }
    }
</style>

<div class="container mt-5 mb-5">

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-wine-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            @TempData["Success"]
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"
                    aria-label="Close"></button>
        </div>
    }

    @if (isHospitalOrBloodBank)
    {
        <div class="alert alert-wine-info alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            Your profile data is managed by the Admin. You can only submit new requests.
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"
                    aria-label="Close"></button>
        </div>
    }

    <div class="card profile-card">
        <div class="profile-header">
            <h5>Profile Information</h5>
        </div>

        <div class="card-body p-4">
            <form asp-controller="Account" asp-action="Profile" method="post">
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.UserId)

                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label">UserName</label>
                        @Html.TextBoxFor(m => m.UserName, new Dictionary<string, object> { ["class"] = "form-control", ["readonly"] = "readonly" })
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Full Name</label>
                        @Html.TextBoxFor(m => m.FullName, textAttrs)
                        <span class="text-danger" asp-validation-for="FullName"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        @Html.TextBoxFor(m => m.Email, textAttrs)
                        <span class="text-danger" asp-validation-for="Email"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Mobile No</label>
                        @Html.TextBoxFor(m => m.MobileNo, textAttrs)
                        <span class="text-danger" asp-validation-for="MobileNo"></span>
                    </div>

                    <div class="@halfLg">
                        <label class="form-label">Address</label>
                        @Html.TextBoxFor(m => m.Address, textAttrs)
                        <span class="text-danger" asp-validation-for="Address"></span>
                    </div>

                    <div class="@halfLg">
                        <label class="form-label">Role</label>
                        <input class="form-control" value="@role" readonly />
                    </div>

                    @if (isDonor || isAdmin)
                    {
                        <div class="@genderCol">
                            <label class="form-label">Gender</label>
                            @Html.DropDownListFor(m => m.Gender, genderItems, selectAttrs)
                            <span class="text-danger" asp-validation-for="Gender"></span>

                            @if (!canEdit)
                            {
                                @Html.HiddenFor(m => m.Gender)
                            }
                        </div>
                    }

                    @if (isDonor)
                    {
                        <div class="col-md-6">
                            <label class="form-label">Blood Type</label>
                            @Html.DropDownListFor(m => m.BloodTypeId, bloodTypeSelectList, "-- Select --", selectAttrs)
                            <span class="text-danger" asp-validation-for="BloodTypeId"></span>

                            @if (!canEdit)
                            {
                                @Html.HiddenFor(m => m.BloodTypeId)
                            }
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Date of Birth</label>
                            @Html.TextBoxFor(
                                m => m.DateOfBirth,
                                "{0:yyyy-MM-dd}",
                                new Dictionary<string, object> { ["class"] = "form-control", ["type"] = "date", ["readonly"] = "readonly" }
                            )
                            <div class="form-text">Date of birth cannot be changed.</div>
                        </div>

                        <div class="@healthCol">
                            <label class="form-label">
                                Health Status <span class="text-muted">(optional)</span>
                            </label>
                            @Html.TextAreaFor(m => m.HealthStatus, 2, 0, textAreaAttrs)
                            <span class="text-danger" asp-validation-for="HealthStatus"></span>
                        </div>
                    }

                </div>

                <div class="profile-actions d-flex flex-column flex-sm-row gap-2 mt-4">
                    @if (!canEdit)
                    {
                        <a class="btn btn-wine px-4 w-100"
                           asp-controller="Admin"
                           asp-action="Dashboard">
                            Go Back
                        </a>
                    }
                    else
                    {
                        <button type="submit" class="btn btn-wine px-4 w-100">
                            <i class="bi bi-check2-circle me-1"></i>Save Changes
                        </button>

                        <a class="btn btn-outline-wine px-4 w-100"
                           asp-controller="Admin"
                           asp-action="Dashboard">
                            Cancel
                        </a>
                    }
                </div>

            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}